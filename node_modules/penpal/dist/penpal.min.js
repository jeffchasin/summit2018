!function(e,n){var t={};!function(e){"use strict";function n(e){if(Array.isArray(e)){for(var n=0,t=Array(e.length);n<e.length;n++)t[n]=e[n];return t}return Array.from(e)}Object.defineProperty(e,"__esModule",{value:!0});var t="message",r={"http:":"80","https:":"443"},o=/^(https?:)?\/\/([^\/:]+)(:(\d+))?/,i={Promise:function(){try{return window?window.Promise:null}catch(e){return null}}(),debug:!1},a=function(){var e=0;return function(){return++e}}(),d=function(){for(var e=arguments.length,n=Array(e),t=0;t<e;t++)n[t]=arguments[t];if(i.debug){var r;(r=console).log.apply(r,["[Penpal]"].concat(n))}},c=function(e){var n=document.location,t=o.exec(e),i=void 0,a=void 0,d=void 0;return t?(i=t[1]?t[1]:n.protocol,a=t[2],d=t[4]):(i=n.protocol,a=n.hostname,d=n.port),i+"//"+a+(d&&d!==r[i]?":"+d:"")},l=function(e){var n=[];return e(function(){n.forEach(function(e){e()})}),{then:function(e){n.push(e)}}},u=function(e,n,r){var o=e.localName,c=e.local,l=e.remote,u=e.remoteOrigin,s=!1;d(o+": Creating call sender");var f=function(e){return function(){for(var n=arguments.length,r=Array(n),f=0;f<n;f++)r[f]=arguments[f];return d(o+": Sending "+e+"() call"),new i.Promise(function(n,i){if(s)return void i("Unable to send "+e+"() call due to destroyed connection");var f=a(),p=function r(a){a.source===l&&a.origin===u&&"reply"===a.data.penpal&&a.data.id===f&&(d(o+": Received "+e+"() reply"),c.removeEventListener(t,r),("fulfilled"===a.data.resolution?n:i)(a.data.returnValue))};c.addEventListener(t,p),l.postMessage({penpal:"call",id:f,methodName:e,args:r},u)})}};return r.then(function(){s=!0}),n.reduce(function(e,n){return e[n]=f(n),e},{})},s=function(e,r,o){var a=e.localName,c=e.local,l=e.remote,u=e.remoteOrigin,s=!1;d(a+": Connecting call receiver");var f=function(e){if(e.source===l&&e.origin===u&&"call"===e.data.penpal){var t=e.data,o=t.methodName,c=t.args,f=t.id;if(d(a+": Received "+o+"() call"),o in r){var p=function(e){return function(n){if(s)return void setTimeout(function(){throw new Error("Unable to send "+o+"() reply due to destroyed connection")});d(a+": Sending "+o+"() reply");try{l.postMessage({penpal:"reply",id:f,resolution:e,returnValue:n},u)}catch(e){"DataCloneError"===e.name&&l.postMessage({penpal:"reply",id:f,resolution:"rejected",returnValue:e.toString()},u),setTimeout(function(){throw e})}}};new i.Promise(function(e,t){try{e(r[o].apply(r,n(c)))}catch(e){t(e.toString()),setTimeout(function(){throw e})}}).then(p("fulfilled"),p("rejected"))}}};c.addEventListener(t,f),o.then(function(){s=!0,c.removeEventListener(t,f)})};i.connectToChild=function(e){var n=e.url,r=e.appendTo,o=e.methods,a=void 0===o?{}:o,f=void 0,p=new l(function(e){return f=e}),v=window,m=document.createElement("iframe");(r||document.body).appendChild(m),p.then(function(){m.parentNode&&m.parentNode.removeChild(m)});var h=m.contentWindow||m.contentDocument.parentWindow,g=c(n);return{promise:new i.Promise(function(e,r){var o=function n(r){if(r.source===h&&r.origin===g&&"handshake"===r.data.penpal){d("Parent: Received handshake"),v.removeEventListener(t,n),d("Parent: Sending handshake reply"),r.source.postMessage({penpal:"handshake-reply",methodNames:Object.keys(a)},r.origin);var o={localName:"parent",local:v,remote:h,remoteOrigin:r.origin};s(o,a,p),e(u(o,r.data.methodNames,p))}};v.addEventListener(t,o),p.then(function(){v.removeEventListener(t,o),r("Parent: Connection destroyed")}),d("Parent: Loading iframe"),m.src=n}),iframe:m,destroy:f}},i.connectToParent=function(e){var n=e.parentOrigin,r=e.methods,o=void 0===r?{}:r,a=void 0,f=new l(function(e){return a=e}),p=window,v=p.parent,m=c(document.referrer);if(void 0===n||Array.isArray(n)||(n=[n]),void 0!==n&&-1===n.indexOf(m))throw new Error("Child: parent's origin not in list of valid parent origins");return{promise:new i.Promise(function(e,r){var i=function r(i){if((void 0===n||-1!==n.indexOf(i.origin))&&i.source===v&&"handshake-reply"===i.data.penpal){d("Child: Received handshake reply"),p.removeEventListener(t,r);var a={localName:"child",local:p,remote:v,remoteOrigin:i.origin};s(a,o,f),e(u(a,i.data.methodNames,f))}};p.addEventListener(t,i),f.then(function(){p.removeEventListener(t,i),r("Child: Connection destroyed")}),d("Child: Sending handshake"),v.postMessage({penpal:"handshake",methodNames:Object.keys(o)},m)}),destroy:a}},e.default=i}(t),"function"==typeof define&&define.amd?define("Penpal",t.default):e.Penpal=t.default}(this);